{% extends "base.html" %}
{% block title %}UNITY 3D - OnlineMachines{% endblock %}
{% block page_content %}
    <div class="page-header">
        {% if current_user.is_authenticated %}
            {% include '_chart_machines.html' %}
            <div class="panel panel-default" style="margin-top: 40px">
                <div class="panel-heading">
                    <h3 class="panel-title" style="font-size: x-large;">
                        <i class="fa fa-sitemap"></i>
                        Online Machines
                    </h3>
                </div>
                <div class="panel-body">
                    <table id="online_machine_table"></table>
                    <div id="toolbar" >
                        <button id="initBtn" class="btn btn-primary">
                            <i class="glyphicon glyphicon-ok-circle"></i>
                            Initalize
                        </button>
                        <button id="rebootBtn" class="btn btn-danger">
                            <i class="glyphicon glyphicon-repeat"></i>
                            Reboot
                        </button>
                    </div>
                </div>
            </div>
        {% else %}
            <h2>Welcome to Unity3D Cloud Factory.</h2>
            <p>
                <a href="{{ url_for('auth.register') }}">
                Click here to register
                </a>
            </p>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='jquery.easypiechart.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap-table.js') }}"></script>
	<script>
    function myInterval(){
        $.getJSON("/online-machines", { cmd: 'machine_info'},
        function (data) { 
            $('#table').bootstrapTable('load', data);
            var total_machines = 0;
            var ready_machines = 0;
            var assigned_machines = 0;
            var fault_machines = 0;
            total_machines = data.length;
            for(var i = 0;i<data.length;i++){
                if(data[i]['state'] == 'ready'){
                    ready_machines++;
                }
                else if(data[i]['state'] == 'assigned'){
                    assigned_machines++;
                }
                else {
                    fault_machines++;
                }
            }
            $('.chart_ready').data('easyPieChart').update(Math.random()*100);
            $('.chart_assigned').data('easyPieChart').update(Math.random()*100);
            $('.chart_fault').data('easyPieChart').update(Math.random()*100);
         });
    }

    $(function() {
        $('.chart_ready').easyPieChart({
            lineCap: 'butt',
            lineWidth: 40,
            trackWidth: 32,
            trackColor: '#ace',
            scaleColor: false,
            size:280,
            onStep: function (from, to, percent_1) {
                this.el.children[0].innerHTML = Math.round(percent_1) + "%";
            }
        });
        $('.chart_assigned').easyPieChart({
            lineCap: 'butt',
            lineWidth: 40,
            trackWidth: 32,
            trackColor: '#ace',
            scaleColor: false,
            size:280,
            onStep: function (from, to, percent_1) {
                this.el.children[0].innerHTML = Math.round(percent_1) + "%";
            }
        });
        $('.chart_fault').easyPieChart({
            lineCap: 'butt',
            lineWidth: 40,
            trackWidth: 32,
            trackColor: '#ace',
            scaleColor: false,
            size:280,
            onStep: function (from, to, percent_1) {
                this.el.children[0].innerHTML = Math.round(percent_1) + "%";
            }
        });
    });

    $(window).ready(function () {
        setInterval("myInterval()", 5000);

        function getSelectionMahineAddrs() {
            var addrs =  $('#online_machine_table').bootstrapTable('getAllSelections');
            var address = []
            for(var i =0;i<addrs.length - 1;i++){
                address.append(addrs[i]['address']);
            }
            return address;
        }

        $('#online_machine_table').bootstrapTable({
            url:'/online-machines?cmd=machine_info',
            search:true,
            showRefresh:true,
            pagination:true,
            pageNumber:1,
            pageSize:10,
            pageList: [10, 25, 50, 100],
            toolbar: '#toolbar',
            columns: [
            {
                checkbox: true
            }, {
                field: 'index',
                title: 'index',
                align: 'center',
                halign: 'center',
                valign: 'center',
                formatter: function (value, row, index) {
                    return index+1;
                }
            }, {
                field: 'address',
                title: 'address',
                align: 'center',
                halign: 'center'
            }, {
                field: 'type',
                title: 'type',
                align: 'center',
                halign: 'center'
            }, {
                field: 'state',
                title: 'state',
                align: 'center',
                halign: 'center'
            }, {
                field: 'task_info',
                title: 'task',
                align: 'center',
                halign: 'center'
            }, {
                field: 'temp_nozzle',
                title: 'temp_nozzle',
                align: 'center',
                halign: 'center'
            }, {
                field: 'temp_bed',
                title: 'temp_bed',
                align: 'center',
                halign: 'center'
            }, {
                field: 'x_size',
                title: 'x',
                align: 'center',
                halign: 'center'
            }, {
                field: 'y_size',
                title: 'y',
                align: 'center',
                halign: 'center'
            }, {
                field: 'z_size',
                title: 'z',
                align: 'center',
                halign: 'center'
            }, {
                field: 'material',
                title: 'material',
                align: 'center',
                halign: 'center'
            }, {
                field: 'material_color',
                title: 'material_color',
                align: 'center',
                halign: 'center'
            }, {
                field: 'nozzle_size',
                title: 'nozzle',
                align: 'center',
                halign: 'center'
            },{
                field: 'worked_time',
                title: 'worked_time',
                align: 'center',
                halign: 'center'
            }],
            onRefresh: function () {
            }
        });
        })
	</script>
{% endblock %}

